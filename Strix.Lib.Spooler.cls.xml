<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<Class name="Strix.Lib.Spooler">
<Description>
Class interface to the Cach√© spooler device.</Description>
<Super>%RegisteredObject</Super>
<TimeCreated>63026,41246.75306</TimeCreated>

<Property name="SavedIO">
<Description>
The value of $IO when the spooler is started</Description>
<Type>%String</Type>
</Property>

<Property name="DocumentNumber">
<Description>
The spool document number</Description>
<Type>%Integer</Type>
</Property>

<Property name="Data">
<Description>
Data collected by the spool device after method Start is called
will be placed here when method Stop is called.</Description>
<Type>%String</Type>
</Property>

<Method name="Start">
<Description>
Starts the spooler; replaces the current device</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>Strix.Lib.Spooler</ReturnType>
<Implementation><![CDATA[
	Set Spooler = ..%New()
	Set Spooler.SavedIO = $IO
	Set Spooler.Data = ""
	Set Spooler.DocumentNumber = Spooler.GetDocNumber()
	Open 2:(Spooler.DocumentNumber)
	Use 2
	Quit Spooler
]]></Implementation>
</Method>

<Method name="Stop">
<Description>
Stops the spooler, restores the previous device, and returns any
data collected when the spooler was active</Description>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	;Stop spooler and restore previous device
	Close 2
	Use ..SavedIO
	
	;Get collected data
	Set Data = ""
	Set LineNr = ""
	For  {
		Set LineNr = $Order(^SPOOL(..DocumentNumber, LineNr), 1, Line)
		If LineNr = "" Quit
		If LineNr = 2147483647 Quit
		Set Data = Data_Line
	}
	Set ..Data = Data
	
	;Clean up
	Kill ^SPOOL(..DocumentNumber)
	Set ..DocumentNumber = ""
	
	;Return data if we're expected to return something
	If $Quit Quit Data
	
	Quit
]]></Implementation>
</Method>

<Method name="GetDocNumber">
<Private>1</Private>
<ReturnType>%Integer</ReturnType>
<Implementation><![CDATA[
	Lock +^SPOOL
	Set DocumentNumber = $Order(^SPOOL(""), -1) + 1
	Lock -^SPOOL
	Quit DocumentNumber
]]></Implementation>
</Method>
</Class>
</Export>
